---
layout: post
title: "使用php实现一个简单的服务器UDP篇"
description: ""
category: 
tags: [网络编程,服务器,进程通信,PHP]
---
{% include JB/setup %}


## 使用PHP实现一个简单的服务器 ##

<img src="udp.png" alt="xxxxxx" style="width:600px;"/>

### 背景 ###

一般基本的web应用程序为了安全都是使得数据访问层和web层进行分离（或者不在同一台机器上）。这也是最基本的做法。

本文通过PHP、socket、进程间通信机制和消息的定制来实现一个基本的中间服务器。我们可以利用这台服务器来来做数据访问，主要的业务逻辑可以放到web层中去。有数据请求即可通过套接字来请求该服务器，来做交互。

另外可以根据web测的业务需求来决定使用tcp方式或者udp的方式与服务器进行通信。

### 基本原理 ###

下面主要介绍UDP架构的原理，TCP的后续补上。

主要原理：

服务层主要包括一个分发用户请求的进程和多个工作进程。分发进程和工作进程之间的通信方式主要通过内核提供的消息队列模式。工作进程处理好后直接将处理结果回复给发送该请求的用户。

-任务分发主进程
	
   该进程其实就是一个UDP的server，一直处于监听状态，负责监听用户的各种请求。然后将用户的消息和用户的ip以及端口号一起打包到消息队列中去（进程间通信这里选择的是消息队列，也可以尝试其他的通信方式）。然后继续处于监听状态。就是一个死循环。这里的消息队列可以设置成多个缓冲的消息队列，然后多个工作进程按一种算法均匀的从多个消息队列中选择一个任务进行处理。可以做均衡灵活的处理。

-工作进程


该进程就是不间断的从合适的消息队列中选择一个任务出来进行处理，然后根据消息中的ip以及端口号 直接将结果发过去。



### 几个小问题 ###




- UDP套接字编程的时候，客户端会在本地随机选择一个未使用过的端口号和ip进行绑定，所以工作进程可以直接将数据根据端口号和ip直接发回来
- UDP套接字编程的时候，包的大小是有限制的，当超过64k的时候，会报错。这点需要注意。

关于tcp模式架构的设计 后续会继续添加。有问题联系xxzapple@126.com